// configurate paths
const config = require('./config');

// create and configure global __server
require(config.SERVER);

for (var alias in config){
	__server[alias] = config[alias];
}

function startServer(port){
	const dispatcher = require(config.DISPATCHER);
	const router = require(__server.hosts[port]);
	__server.start(dispatcher(router), port);
}

const cluster = require('cluster');

if (cluster.isMaster){
	console.log('master process was started');
	
	module.exports = function(hosts){
		__server.config = require(config.CONFIG_MAIN);
		__server.setHosts(hosts);
		
		let ports = Object.keys(__server.hosts);
		
		startServer(ports[0]);
		
		if (ports.length == 1) return;
		
		for (var i = 1; i < ports.length; i++){
			cluster.fork({port: ports[i]});
		}
	};
}
else{
	console.log('child process was started');
	
	cluster.on('exit', (worker, code, signal) => {
		__server.msg('worker %d died', worker.process.pid);
	});
	
	startServer(process.env.port);
}